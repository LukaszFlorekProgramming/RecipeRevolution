@page "/reset-password-confirm"
@using RecipeRevolutionBlazorApp.Services.Users

@inject IUserService UserService
@inject NavigationManager Navigation

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h3>Confirm Reset Password</h3>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            <EditForm Model="@confirmResetPasswordDto" OnValidSubmit="ConfirmResetPasswordAsync">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="Code">Reset Code</label>
                    <InputText id="Code" @bind-Value="confirmResetPasswordDto.ResetCode" class="form-control" />
                </div>

                <div class="form-group">
                    <label for="NewPassword">New Password</label>
                    <InputText id="NewPassword" type="password" @bind-Value="confirmResetPasswordDto.NewPassword" class="form-control" />
                </div>

                <div class="form-group d-flex justify-content-center mt-3">
                    <button type="submit" class="btn btn-primary">Confirm Reset</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private Models.User.ConfirmResetPasswordDto confirmResetPasswordDto = new Models.User.ConfirmResetPasswordDto();
    private string successMessage;
    private string errorMessage;

    private string email;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        email = query["email"];
        confirmResetPasswordDto.Email = email;
    }

    private async Task ConfirmResetPasswordAsync()
    {
        try
        {
            var result = await UserService.ConfirmResetPassword(confirmResetPasswordDto);
            if (result)
            {
                successMessage = "Your password has been reset successfully.";
                Navigation.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Error resetting password. Please check your reset code and try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }
}
